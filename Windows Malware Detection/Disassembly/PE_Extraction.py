import pefile,re,cpp_demangle

def decode_mangled_cpp(to_decode):
    to_decode_str = to_decode.decode('utf-8')
    print(to_decode_str)
    decoded_symbol = cpp_demangle.demangled(to_decode_str)
    print(type(decoded_symbol))
    return decoded_symbol
    
# Check for mangled C++ names
def is_mangled_cpp_name(function_name):
    function_name_str = function_name.decode('utf-8')
    return any(char in function_name_str for char in ['?', '$', '@'])

def imported_functions_and_DLLs(pe_file_path):
    pe = pefile.PE(pe_file_path)
    pe.parse_data_directories()
    dll_imported = list()
    imported_functions = list()
    cpp_mangle_imports = list()
    # Iterate through imported DLLs
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        dll_name = entry.dll.decode("utf-8")
        #if dll_name not in dll_imported:
        dll_imported.append(dll_name)
        for imp in entry.imports:
            name = imp.name
            if is_mangled_cpp_name(imp.name) == False:
                name = imp.name.decode("utf-8")
                imported_functions.append(name)
            else:
                name = imp.name.decode("utf-8")
                cpp_mangle_imports.append(name)   

    return dll_imported,imported_functions,cpp_mangle_imports

def PE_sections_exctractions(pe_file_path):
    pe = pefile.PE(pe_file_path)


    for section in pe.sections:
        sections_name =  (".text",".data",".rdata",".bss",".idata",".edata",".rsrc",".reloc",".tls",".pdata")
        pe_sections = dict()
        section_name = section.Name.decode("utf-8")
        if section_name == ".text":
            section["text"] = {"Misc_VirtualSize":section.Misc_VirtualSize,"VirtualAddress":section.VirtualAddress,
                               "SizeOfRawData":section.SizeOfRawData,"PointerToRawData":section.PointerToRawData,
                               "PointerToRelocations":section.PointerToRelocations,"PointerToLinenumbers":section.PointerToLinenumbers,
                               "NumberOfRelocations":section.NumberOfRelocations,"NumberOfLinenumbers":section.NumberOfLinenumbers,
                               "Characteristics":section.Characteristics}
        